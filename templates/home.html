<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>age Keyserver</title>
	<link rel="stylesheet" href="/static/style.css">
	<script src="https://js.hcaptcha.com/1/api.js" async defer></script>
</head>
<body>
	<h1>age Keyserver</h1>

	<p>A simple public keyserver for <a href="https://age-encryption.org" target="_blank">age</a> encryption.</p>

	<div class="section lookup-section">
		<h2>Look up a public key</h2>
		<form id="lookup-form">
			<input type="email" id="lookup-email" name="email" required placeholder="Enter email address to find their age public key" autofocus>
			<button type="submit">Look up key</button>
		</form>
		<div id="lookup-result"></div>
	</div>

	<div class="section">
		<h2>Manage your key</h2>
		<p>To set or update your own public key, enter your email address to receive a login link:</p>
		<form action="/login" method="POST">
			<label for="email">Email address</label>
			<input type="email" id="email" name="email" required placeholder="you@example.com">

			<div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>

			<button type="submit">Send login link</button>
		</form>
	</div>

	<div class="footer">
		<p>Learn more about <a href="https://age-encryption.org" target="_blank">age encryption</a></p>
	</div>

	<script>
		const BROADCAST_CHANNEL_NAME = 'age-keyserver-auth';

		function copyToClipboard(text) {
			navigator.clipboard.writeText(text).then(() => {
				const btn = document.getElementById('copy-btn');
				const originalText = btn.textContent;
				btn.textContent = 'Copied!';
				btn.style.background = 'var(--button-bg)';
				setTimeout(() => {
					btn.textContent = originalText;
					btn.style.background = '';
				}, 2000);
			}).catch(err => {
				console.error('Failed to copy:', err);
			});
		}

		document.getElementById('lookup-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const email = document.getElementById('lookup-email').value;
			const resultDiv = document.getElementById('lookup-result');

			resultDiv.innerHTML = '<p style="margin-top: 1rem;" class="dimmed">Looking up...</p>';

			try {
				const resp = await fetch('/lookup?email=' + encodeURIComponent(email));
				if (resp.ok) {
					const data = await resp.json();
					resultDiv.innerHTML = `
						<div style="margin-top: 1.5rem;">
							<p><strong>Public key for ${email}:</strong></p>
							<div class="key-result">
								<code class="pubkey-display">${data.pubkey}</code>
								<button id="copy-btn" onclick="copyToClipboard('${data.pubkey}')" class="copy-button">Copy</button>
							</div>
						</div>
					`;
				} else {
					resultDiv.innerHTML = '<p style="margin-top: 1rem;" class="error">No key found for this email address.</p>';
				}
			} catch (err) {
				resultDiv.innerHTML = '<p style="margin-top: 1rem;" class="error">Error looking up key.</p>';
			}
		});

		// Listen for auth tokens from other tabs via BroadcastChannel
		const authChannel = new BroadcastChannel(BROADCAST_CHANNEL_NAME);
		authChannel.addEventListener('message', (event) => {
			if (event.data.type === 'auth-token') {
				const { email, ts, sig } = event.data;

				// Send confirmation back to the sender tab
				authChannel.postMessage({
					type: 'token-received-confirmation'
				});

				// Redirect to auth page with the token
				window.location.href = `/auth#email=${encodeURIComponent(email)}&ts=${encodeURIComponent(ts)}&sig=${encodeURIComponent(sig)}`;
			}
		});
	</script>
</body>
</html>
